<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Prescription</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #f4f6f8; }
        h2 { text-align: center; color: #333; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        .med-card { 
            border: 1px solid #e1e4e8; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            background: white; 
            position: relative;
        }
        
        /* Remove button for medicine rows */
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            line-height: 25px;
            text-align: center;
            padding: 0;
        }

        .action-btn { background: #007bff; color: white; margin-bottom: 20px; width: auto; display: inline-block; }
        .submit-btn { background: #28a745; color: white; width: 100%; font-size: 18px; margin-top: 20px;}
        button { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { opacity: 0.9; }
        
        .consent-checkbox { 
            margin-top: 30px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            border: 1px solid #e1e4e8;
        }
        .consent-checkbox label { 
            display: flex; 
            align-items: flex-start; 
            cursor: pointer; 
            font-weight: normal;
            margin-bottom: 0;
        }
        .consent-checkbox input[type="checkbox"] { 
            width: auto; 
            margin-right: 10px; 
            margin-top: 3px; 
            cursor: pointer;
            flex-shrink: 0;
        }
        .consent-checkbox span { 
            line-height: 1.5; 
            color: #333;
        }
        
        #loading { text-align: center; font-style: italic; color: #666; margin-top: 50px; }
        
        .error-field {
            border: 2px solid #ff4d4d !important;
            background-color: #fff5f5;
        }
        .error-message {
            color: #ff4d4d;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }

        .section-note {
            font-size: 12px;
            color: #888;
            font-style: italic;
            margin-bottom: 10px;
        }

        .api-status {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 12px;
            word-break: break-all;
        }
        .api-status.error {
            background: #ffe7e7;
            border-color: #ffb3b3;
        }
    </style>
</head>
<body>

    <h2>Review Prescription Details</h2>
    
    <div id="loading">Loading data...</div>

    <form id="dataForm" style="display:none;">
        <div id="apiStatus" class="api-status" style="display:none;"></div>

        <h3>API Configuration</h3>
        <div class="input-group">
            <label>Backend URL (ngrok)</label>
            <input type="text" id="api_url" placeholder="https://your-ngrok-url.ngrok-free.app">
        </div>

        <h3>Patient Info</h3>
        <div class="input-group">
            <label>Name</label>
            <input type="text" id="p_name" placeholder="Patient Name">
        </div>
        <div class="input-group">
            <label>Age</label>
            <input type="number" id="p_age" placeholder="Age">
        </div>
        <div class="input-group">
            <label>Diagnosis</label>
            <input type="text" id="p_diagnosis" placeholder="Diagnosis">
        </div>
        <div class="input-group">
            <label>Mobile Number</label>
            <input type="tel" id="p_mobile" placeholder="Mobile Number" readonly>
        </div>
        <div class="input-group">
            <label>Preferred Language</label>
            <select id="p_language">
                <option value="">Select Language</option>
                <option value="ENGLISH">English</option>
                <option value="HINDI">Hindi</option>
                <option value="BENGALI">Bengali</option>
                <option value="TELUGU">Telugu</option>
                <option value="MARATHI">Marathi</option>
                <option value="TAMIL">Tamil</option>
                <option value="GUJARATI">Gujarati</option>
                <option value="KANNADA">Kannada</option>
                <option value="MALAYALAM">Malayalam</option>
                <option value="ODIA">Odia</option>
                <option value="PUNJABI">Punjabi</option>
                <option value="URDU">Urdu</option>
                <option value="ASSAMESE">Assamese</option>
            </select>
        </div>

        <h3>Doctor Info</h3>
        <div class="input-group">
            <label>Doctor Name</label>
            <input type="text" id="d_name" placeholder="Doctor Name">
        </div>
        <div class="input-group">
            <label>Clinic Name</label>
            <input type="text" id="d_clinic" placeholder="Clinic Name">
        </div>
        <div class="input-group">
            <label>Contact Number</label>
            <input type="tel" id="d_contact" placeholder="Contact Number">
        </div>
        <div class="input-group">
            <label>City</label>
            <input type="text" id="d_city" placeholder="e.g. Mumbai">
        </div>
        <div class="input-group">
            <label>Specialization</label>
            <input type="text" id="d_specialization" placeholder="e.g. Orthopedic, General Physician">
        </div>

        <h3>Medicines</h3>
        <p class="section-note">Review and edit your medication schedule</p>
        <div id="meds-container"></div>
        
        <button type="button" class="action-btn" onclick="addMedicineRow()">+ Add Medicine</button>

        <div class="consent-checkbox">
            <label>
                <input type="checkbox" id="consent_checkbox" required>
                <span>I consent to the processing of my health data for the purpose of scheduling medication reminders. I understand that this app uses AI to extract details and is not a substitute for professional medical advice. I have verified that the information above is correct.</span>
            </label>
        </div>

        <button type="submit" class="submit-btn">Confirm & Save</button>
    </form>

    <script>
        // --- CONFIGURATION ---
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const mobileNumber = urlParams.get('phone');  // Patient mobile number
        const apiBaseParam = urlParams.get('api'); // Optional: ngrok URL for backend
        
        // Store IDs for later use
        let patientId = null;
        let doctorId = null;
        let existingPrescriptions = [];

        // Debug: Log configuration
        console.log('Configuration:', {
            mobileNumber,
            apiBaseParam
        });

        // Get API_BASE from form input (with /api suffix)
        function getApiBase() {
            const urlInput = document.getElementById('api_url').value.trim();
            if (!urlInput) return null;
            return urlInput.endsWith('/api') ? urlInput : `${urlInput}/api`;
        }

        // --- HELPER FUNCTIONS ---

        // Add a medicine row with optional data
        function addMedicineRow(name = '', freqValue = '', freqUnit = 'MONTHS', nextDose = '', dosage = '', instructions = '', prescriptionId = null, medicineId = null) {
            const container = document.getElementById('meds-container');
            const rowId = Date.now();
            
            const html = `
                <div class="med-card" id="row-${rowId}" 
                     data-prescription-id="${prescriptionId || ''}" 
                     data-medicine-id="${medicineId || ''}">
                    <button type="button" class="remove-btn" onclick="removeRow('${rowId}')" title="Remove medicine">Ã—</button>
                    <label>Medicine Name</label>
                    <input type="text" class="med-name" value="${escapeHtml(name)}" placeholder="e.g. Denuril 60mg">
                    <label style="margin-top:10px">Dosage</label>
                    <input type="text" class="med-dosage" value="${escapeHtml(dosage)}" placeholder="e.g. 60mg, 1 tablet">
                    <label style="margin-top:10px">Frequency</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" class="med-freq-value" value="${freqValue}" placeholder="e.g. 6" min="1" style="flex: 1;">
                        <select class="med-freq-unit" style="flex: 1;">
                            <option value="HOURS" ${freqUnit === 'HOURS' ? 'selected' : ''}>Hours</option>
                            <option value="DAYS" ${freqUnit === 'DAYS' ? 'selected' : ''}>Days</option>
                            <option value="WEEKS" ${freqUnit === 'WEEKS' ? 'selected' : ''}>Weeks</option>
                            <option value="MONTHS" ${freqUnit === 'MONTHS' ? 'selected' : ''}>Months</option>
                        </select>
                    </div>
                    <label style="margin-top:10px">Next Dose</label>
                    <input type="datetime-local" class="med-next-dose" value="${nextDose}">
                    <label style="margin-top:10px">Instructions</label>
                    <textarea class="med-instructions" placeholder="e.g. Take after meals, Subcutaneous injection" style="width:100%; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; min-height:60px; resize:vertical;">${escapeHtml(instructions)}</textarea>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            
            // Attach error clearing listeners
            const newRow = document.getElementById(`row-${rowId}`);
            newRow.querySelectorAll('.med-name, .med-dosage, .med-freq-value, .med-freq-unit, .med-next-dose, .med-instructions').forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentElement.querySelector('.error-message');
                    if (errorMsg) errorMsg.remove();
                });
                input.addEventListener('change', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentElement.querySelector('.error-message');
                    if (errorMsg) errorMsg.remove();
                });
            });
        }

        // Remove a medicine row
        function removeRow(id) {
            document.getElementById(`row-${id}`).remove();
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format datetime for input
        function formatDateTimeLocal(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '';
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (e) {
                console.warn('Error formatting date:', e);
                return '';
            }
        }

        // Show API status message
        function showApiStatus(message, isError = false) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'api-status error' : 'api-status';
            statusDiv.style.display = 'block';
        }

        // --- MAIN LOAD FUNCTION ---
        async function loadData() {
            const API_BASE = getApiBase();

            // Manual entry mode if no mobile number or no API URL
            if (!mobileNumber || !API_BASE) {
                console.log("No mobile number or API URL provided, showing empty form");
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataForm').style.display = 'block';
                if (!API_BASE) {
                    showApiStatus('Enter your ngrok URL above and provide ?phone=9876543210 in URL to load data.', false);
                } else {
                    showApiStatus('Manual entry mode - No phone number provided. Use ?phone=9876543210 in URL.', false);
                }
                addMedicineRow();
                return;
            }

            try {
                // 1. Fetch patient data
                console.log(`Fetching patient data for: ${mobileNumber}`);
                const patientRes = await fetch(`${API_BASE}/patients/mobile/${mobileNumber}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'ngrok-skip-browser-warning': 'true'  // Skip ngrok warning page
                    }
                });
                
                if (!patientRes.ok) {
                    throw new Error(`Patient not found (${patientRes.status})`);
                }
                
                const patient = await patientRes.json();
                console.log('Patient data:', patient);
                
                // Store patient ID for updates
                patientId = patient.id;
                
                // Populate patient fields
                document.getElementById('p_name').value = patient.name || '';
                document.getElementById('p_age').value = patient.age || '';
                document.getElementById('p_diagnosis').value = patient.diagnosis || '';
                document.getElementById('p_mobile').value = patient.mobileNumber || mobileNumber;
                
                // Set language (backend returns uppercase enum values)
                if (patient.preferredLanguage) {
                    const langSelect = document.getElementById('p_language');
                    const langValue = patient.preferredLanguage.toUpperCase();
                    const optionExists = Array.from(langSelect.options).some(opt => opt.value === langValue);
                    if (optionExists) {
                        langSelect.value = langValue;
                    }
                }

                // 2. Fetch prescriptions (includes medicine info)
                console.log(`Fetching prescriptions for: ${mobileNumber}`);
                const prescriptionsRes = await fetch(`${getApiBase()}/prescriptions/patient/mobile/${mobileNumber}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (prescriptionsRes.ok) {
                    const prescriptions = await prescriptionsRes.json();
                    console.log('Prescriptions data:', prescriptions);
                    
                    // Store for later use
                    existingPrescriptions = prescriptions;
                    
                    // Populate medicines
                    if (prescriptions.length > 0) {
                        prescriptions.forEach(rx => {
                            const nextDoseValue = formatDateTimeLocal(rx.nextDose);
                            
                            addMedicineRow(
                                rx.medicineBrandName || '',
                                rx.frequencyValue || '',
                                rx.frequencyUnit || 'MONTHS',
                                nextDoseValue,
                                rx.dosage || '',
                                rx.instructions || '',
                                rx.id,          // prescription ID
                                rx.medicineId   // medicine ID
                            );
                        });
                    } else {
                        addMedicineRow();
                    }
                } else {
                    console.warn('Could not fetch prescriptions, showing empty medicine row');
                    addMedicineRow();
                }

                // 3. Try to fetch doctor info (if patient has linked doctor)
                // Note: This requires backend to expose doctorId in PatientResponse
                // For now, we'll leave doctor fields empty or try to get from prescription context
                
                showApiStatus(`Connected to: ${getApiBase()}`, false);

            } catch (err) {
                console.error("Error loading data:", err);
                showApiStatus(`Error: ${err.message}. Check console for details.`, true);
                
                // Show form with empty data so user isn't stuck
                document.getElementById('p_mobile').value = mobileNumber || '';
                addMedicineRow();
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataForm').style.display = 'block';
            }
        }

        // --- VALIDATION FUNCTION ---
        function validateForm() {
            let isValid = true;

            // Remove previous error styling
            document.querySelectorAll('.error-field').forEach(el => el.classList.remove('error-field'));
            document.querySelectorAll('.error-message').forEach(el => el.remove());

            // Patient Info Validation
            const pName = document.getElementById('p_name').value.trim();
            const pAge = document.getElementById('p_age').value.trim();
            const pMobile = document.getElementById('p_mobile').value.trim();
            const pLanguage = document.getElementById('p_language').value.trim();

            if (!pName) {
                markError('p_name', 'Patient name is required');
                isValid = false;
            }
            if (!pAge) {
                markError('p_age', 'Patient age is required');
                isValid = false;
            }
            if (!pMobile) {
                markError('p_mobile', 'Mobile number is required');
                isValid = false;
            }
            if (!pLanguage) {
                markError('p_language', 'Preferred language is required');
                isValid = false;
            }

            // Medicines Validation
            const medCards = document.querySelectorAll('.med-card');
            let hasValidMedicine = false;

            if (medCards.length === 0) {
                alert('Please add at least one medicine.');
                isValid = false;
            } else {
                medCards.forEach(card => {
                    const nameInput = card.querySelector('.med-name');
                    const freqValueInput = card.querySelector('.med-freq-value');
                    const freqUnitInput = card.querySelector('.med-freq-unit');
                    const nextDoseInput = card.querySelector('.med-next-dose');
                    
                    const name = nameInput?.value.trim() || '';
                    const freqValue = freqValueInput?.value.trim() || '';
                    const freqUnit = freqUnitInput?.value || '';
                    const nextDose = nextDoseInput?.value.trim() || '';

                    if (name || freqValue || nextDose) {
                        // If any field is filled, all should be filled
                        if (!name) {
                            markError(nameInput, 'Medicine name is required');
                            isValid = false;
                        }
                        if (!freqValue) {
                            markError(freqValueInput, 'Frequency value is required');
                            isValid = false;
                        }
                        if (!freqUnit) {
                            markError(freqUnitInput, 'Frequency unit is required');
                            isValid = false;
                        }
                        if (!nextDose) {
                            markError(nextDoseInput, 'Next dose date is required');
                            isValid = false;
                        }
                        if (name && freqValue && freqUnit && nextDose) {
                            hasValidMedicine = true;
                        }
                    }
                });

                if (!hasValidMedicine) {
                    alert('Please add at least one complete medicine entry.');
                    isValid = false;
                }
            }

            // Consent Validation
            const consentCheckbox = document.getElementById('consent_checkbox');
            if (!consentCheckbox.checked) {
                consentCheckbox.classList.add('error-field');
                const errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'You must provide consent to proceed';
                consentCheckbox.closest('.consent-checkbox').appendChild(errorMsg);
                isValid = false;
            }

            return isValid;
        }

        // Mark field with error
        function markError(elementIdOrElement, message) {
            const element = typeof elementIdOrElement === 'string' 
                ? document.getElementById(elementIdOrElement) 
                : elementIdOrElement;
            
            if (element) {
                element.classList.add('error-field');
                const errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                errorMsg.textContent = message;
                element.parentElement?.appendChild(errorMsg);
            }
        }

        // --- SUBMIT HANDLER ---
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!validateForm()) {
                const firstError = document.querySelector('.error-field');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }
            
            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.textContent = "Saving...";
            submitBtn.disabled = true;

            try {
                const API_BASE = getApiBase();
                if (!API_BASE) {
                    throw new Error('Please enter the Backend URL (ngrok) first');
                }

                // 1. Update Patient
                if (patientId) {
                    console.log('Updating patient:', patientId);
                    const patientUpdateRes = await fetch(`${API_BASE}/patients/${patientId}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({
                            name: document.getElementById('p_name').value.trim(),
                            age: parseInt(document.getElementById('p_age').value) || 0,
                            diagnosis: document.getElementById('p_diagnosis').value.trim(),
                            mobileNumber: document.getElementById('p_mobile').value.trim(),
                            preferredLanguage: document.getElementById('p_language').value,
                            consentGiven: true
                        })
                    });
                    
                    if (!patientUpdateRes.ok) {
                        const errorData = await patientUpdateRes.json().catch(() => ({}));
                        throw new Error(errorData.message || `Failed to update patient (${patientUpdateRes.status})`);
                    }
                    console.log('Patient updated successfully');
                }

                // 2. Update Prescriptions
                const medCards = document.querySelectorAll('.med-card');
                for (const card of medCards) {
                    const prescriptionId = card.dataset.prescriptionId;
                    const medicineId = card.dataset.medicineId;
                    const medName = card.querySelector('.med-name').value.trim();
                    const medDosage = card.querySelector('.med-dosage').value.trim();
                    const freqValue = card.querySelector('.med-freq-value').value;
                    const freqUnit = card.querySelector('.med-freq-unit').value;
                    const nextDose = card.querySelector('.med-next-dose').value;
                    const medInstructions = card.querySelector('.med-instructions').value.trim();
                    
                    if (!medName) continue;

                    // Get frequency value and unit from form
                    const frequencyValue = parseInt(freqValue) || 1;
                    const frequencyUnit = freqUnit || 'MONTHS';

                    if (prescriptionId && medicineId) {
                        // Update existing prescription
                        console.log('Updating prescription:', prescriptionId);
                        const rxUpdateRes = await fetch(`${API_BASE}/prescriptions/${prescriptionId}`, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true'
                            },
                            body: JSON.stringify({
                                patientId: patientId,
                                medicineId: parseInt(medicineId),
                                frequencyValue: frequencyValue,
                                frequencyUnit: frequencyUnit,
                                dosage: medDosage || null,
                                instructions: medInstructions || null,
                                nextDose: nextDose || null
                            })
                        });
                        
                        if (!rxUpdateRes.ok) {
                            console.warn(`Failed to update prescription ${prescriptionId}:`, rxUpdateRes.status);
                        }
                    } else {
                        // New medicine - need to search/create medicine first, then create prescription
                        console.log('Creating new prescription for:', medName);
                        
                        // Search for medicine by name
                        const searchRes = await fetch(`${API_BASE}/medicines/search?q=${encodeURIComponent(medName)}`, {
                            headers: { 'ngrok-skip-browser-warning': 'true' }
                        });
                        
                        let newMedicineId = null;
                        if (searchRes.ok) {
                            const medicines = await searchRes.json();
                            if (medicines.length > 0) {
                                newMedicineId = medicines[0].id;
                                console.log('Found existing medicine:', newMedicineId);
                            }
                        }
                        
                        // Create medicine if not found
                        if (!newMedicineId) {
                            console.log('Creating new medicine:', medName);
                            const createMedRes = await fetch(`${API_BASE}/medicines`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'ngrok-skip-browser-warning': 'true'
                                },
                                body: JSON.stringify({
                                    brandName: medName,
                                    defaultFrequencyValue: frequencyValue,
                                    defaultFrequencyUnit: frequencyUnit,
                                    defaultInstructions: medInstructions || null
                                })
                            });
                            
                            if (createMedRes.ok) {
                                const newMed = await createMedRes.json();
                                newMedicineId = newMed.id;
                                console.log('Created new medicine:', newMedicineId);
                            }
                        }
                        
                        // Create prescription if we have medicine ID
                        if (newMedicineId && patientId) {
                            const createRxRes = await fetch(`${API_BASE}/prescriptions`, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'ngrok-skip-browser-warning': 'true'
                                },
                                body: JSON.stringify({
                                    patientId: patientId,
                                    medicineId: newMedicineId,
                                    frequencyValue: frequencyValue,
                                    frequencyUnit: frequencyUnit,
                                    dosage: medDosage || null,
                                    instructions: medInstructions || null,
                                    nextDose: nextDose || null
                                })
                            });
                            
                            if (createRxRes.ok) {
                                console.log('Created new prescription');
                            } else {
                                console.warn('Failed to create prescription:', createRxRes.status);
                            }
                        }
                    }
                }

                // 3. Mark verification as complete
                if (patientId) {
                    console.log('Marking verification complete for patient:', patientId);
                    const verifyRes = await fetch(`${API_BASE}/patients/${patientId}/verify`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                    
                    if (!verifyRes.ok) {
                        const errorData = await verifyRes.json().catch(() => ({}));
                        console.warn('Verification status update failed:', errorData.message || verifyRes.status);
                        // Don't throw - data is saved, just status update failed
                    } else {
                        console.log('Verification marked complete');
                    }
                }

                alert("Saved and verified successfully! You can close this page.");
                
                // Try to close window, or show success message
                try {
                    window.close();
                } catch (e) {
                    submitBtn.textContent = "Saved Successfully!";
                    submitBtn.style.background = '#28a745';
                }
                
            } catch (error) {
                console.error("Save error:", error);
                alert("Error: " + error.message);
                submitBtn.textContent = "Confirm & Save";
                submitBtn.disabled = false;
            }
        });

        // --- ERROR CLEARING FUNCTIONS ---
        function clearErrorOnInput(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                const handler = function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentElement?.querySelector('.error-message');
                    if (errorMsg) errorMsg.remove();
                };
                element.addEventListener('input', handler);
                element.addEventListener('change', handler);
            }
        }

        function setupConsentCheckboxListener() {
            const consentCheckbox = document.getElementById('consent_checkbox');
            if (consentCheckbox) {
                consentCheckbox.addEventListener('change', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.closest('.consent-checkbox')?.querySelector('.error-message');
                    if (errorMsg) errorMsg.remove();
                });
            }
        }

        // --- INITIALIZATION ---
        // Pre-fill API URL from URL parameter if provided
        if (apiBaseParam) {
            document.getElementById('api_url').value = apiBaseParam;
        }

        // Setup error clearing for form fields
        clearErrorOnInput('api_url');
        clearErrorOnInput('p_name');
        clearErrorOnInput('p_age');
        clearErrorOnInput('p_diagnosis');
        clearErrorOnInput('p_mobile');
        clearErrorOnInput('p_language');
        clearErrorOnInput('d_name');
        clearErrorOnInput('d_clinic');
        clearErrorOnInput('d_contact');
        clearErrorOnInput('d_city');
        clearErrorOnInput('d_specialization');

        // Setup consent checkbox listener
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupConsentCheckboxListener);
        } else {
            setupConsentCheckboxListener();
        }

        // Start loading data
        loadData();

    </script>
</body>
</html>

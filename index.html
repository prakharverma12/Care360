<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Prescription</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #f4f6f8; }
        h2 { text-align: center; color: #333; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        .med-card { 
            border: 1px solid #e1e4e8; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            background: white; 
            position: relative;
        }
        
        /* Remove button for medicine rows */
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            line-height: 25px;
            text-align: center;
            padding: 0;
        }

        .action-btn { background: #007bff; color: white; margin-bottom: 20px; width: auto; display: inline-block; }
        .submit-btn { background: #28a745; color: white; width: 100%; font-size: 18px; margin-top: 20px;}
        button { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { opacity: 0.9; }
        
        .consent-checkbox { 
            margin-top: 30px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            border: 1px solid #e1e4e8;
        }
        .consent-checkbox label { 
            display: flex; 
            align-items: flex-start; 
            cursor: pointer; 
            font-weight: normal;
            margin-bottom: 0;
        }
        .consent-checkbox input[type="checkbox"] { 
            width: auto; 
            margin-right: 10px; 
            margin-top: 3px; 
            cursor: pointer;
            flex-shrink: 0;
        }
        .consent-checkbox span { 
            line-height: 1.5; 
            color: #333;
        }
        
        #loading { text-align: center; font-style: italic; color: #666; margin-top: 50px; }
        
        .error-field {
            border: 2px solid #ff4d4d !important;
            background-color: #fff5f5;
        }
        .error-message {
            color: #ff4d4d;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }
    </style>
</head>
<body>

    <h2>Review Details</h2>
    <div id="loading">Loading data...</div>

    <form id="dataForm" style="display:none;">
        <h3>Patient Info</h3>
        <div class="input-group">
            <label>Name</label>
            <input type="text" id="p_name" placeholder="Patient Name">
        </div>
        <div class="input-group">
            <label>Age</label>
            <input type="number" id="p_age" placeholder="Age">
        </div>
        <div class="input-group">
            <label>Diagnosis</label>
            <input type="text" id="p_diagnosis" placeholder="Diagnosis">
        </div>
        <div class="input-group">
            <label>Mobile Number</label>
            <input type="tel" id="p_mobile" placeholder="Mobile Number">
        </div>
        <div class="input-group">
            <label>Preferred Language</label>
            <select id="p_language">
                <option value="">Select Language</option>
                <option value="English">English</option>
                <option value="Hindi">Hindi</option>
                <option value="Bengali">Bengali</option>
                <option value="Telugu">Telugu</option>
                <option value="Marathi">Marathi</option>
                <option value="Tamil">Tamil</option>
                <option value="Gujarati">Gujarati</option>
                <option value="Kannada">Kannada</option>
                <option value="Malayalam">Malayalam</option>
                <option value="Odia">Odia</option>
                <option value="Punjabi">Punjabi</option>
                <option value="Urdu">Urdu</option>
                <option value="Assamese">Assamese</option>
                <option value="Sanskrit">Sanskrit</option>
            </select>
        </div>

        <h3>Doctor Info</h3>
        <div class="input-group">
            <label>Doctor Name</label>
            <input type="text" id="d_name" placeholder="Doctor Name">
        </div>
        <div class="input-group">
            <label>Clinic Name</label>
            <input type="text" id="d_clinic" placeholder="Clinic Name">
        </div>
        <div class="input-group">
            <label>Contact Number</label>
            <input type="tel" id="d_contact" placeholder="Contact Number">
        </div>

        <h3>Pharma Details</h3>
        <div class="input-group">
            <label>Name</label>
            <input type="text" id="pharma_name" placeholder="Medical Representative Name">
        </div>
        <div class="input-group">
            <label>Contact Number</label>
            <input type="tel" id="pharma_contact" placeholder="Contact Number">
        </div>
        <div class="input-group">
            <label>Company</label>
            <input type="text" id="pharma_company" placeholder="Company Name">
        </div>
        <div class="input-group">
            <label>Area</label>
            <input type="text" id="pharma_area" placeholder="Area">
        </div>
        <div class="input-group">
            <label>State</label>
            <select id="pharma_state">
                <option value="">Select State</option>
            </select>
        </div>
        <div class="input-group">
            <label>City</label>
            <select id="pharma_city">
                <option value="">Select City</option>
            </select>
        </div>

        <h3>Medicines</h3>
        <div id="meds-container"></div>
        
        <button type="button" class="action-btn" onclick="addMedicineRow()">+ Add Medicine</button>

        <div class="consent-checkbox">
            <label>
                <input type="checkbox" id="consent_checkbox" required>
                <span>I consent to the processing of my health data for the purpose of scheduling medication reminders. I understand that this app uses AI to extract details and is not a substitute for professional medical advice. I have verified that the information above is correct.</span>
            </label>
        </div>

        <button type="submit" class="submit-btn">✅ Confirm & Save</button>
    </form>

    <script>
        // --- CONFIGURATION ---
        // Get ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('id');
        const recordEnv = urlParams.get('env');
        
        // Set webhook URLs based on environment
        const GET_WEBHOOK = recordEnv === 'test' 
            ? 'https://prakharverma.app.n8n.cloud/webhook-test/ddbfd381-7399-466d-a1a3-1aa30a57546b'
            : 'https://prakharverma.app.n8n.cloud/webhook/ddbfd381-7399-466d-a1a3-1aa30a57546b';
        
        const POST_WEBHOOK = recordEnv === 'test'
            ? 'https://prakharverma.app.n8n.cloud/webhook-test/ddbfd381-7399-466d-a1a3-1aa30a57546b'
            : 'https://prakharverma.app.n8n.cloud/webhook/ddbfd381-7399-466d-a1a3-1aa30a57546b';

        // Indian States and Cities Data
        const indianStatesAndCities = {
            "Andhra Pradesh": ["Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Kurnool", "Rajahmundry", "Tirupati", "Kakinada", "Anantapur", "Kadapa"],
            "Arunachal Pradesh": ["Itanagar", "Naharlagun", "Tawang", "Pasighat", "Ziro", "Along", "Tezu", "Bomdila"],
            "Assam": ["Guwahati", "Silchar", "Dibrugarh", "Jorhat", "Nagaon", "Tinsukia", "Tezpur", "Sivasagar", "Bongaigaon", "Dhubri"],
            "Bihar": ["Patna", "Gaya", "Bhagalpur", "Muzaffarpur", "Purnia", "Darbhanga", "Bihar Sharif", "Arrah", "Begusarai", "Katihar"],
            "Chhattisgarh": ["Raipur", "Bhilai", "Bilaspur", "Durg", "Korba", "Rajnandgaon", "Raigarh", "Jagdalpur", "Ambikapur", "Chirmiri"],
            "Goa": ["Panaji", "Margao", "Vasco da Gama", "Mapusa", "Ponda", "Mormugao"],
            "Gujarat": ["Ahmedabad", "Surat", "Vadodara", "Rajkot", "Bhavnagar", "Jamnagar", "Gandhinagar", "Junagadh", "Gandhidham", "Anand"],
            "Haryana": ["Faridabad", "Gurgaon", "Panipat", "Ambala", "Yamunanagar", "Rohtak", "Hisar", "Karnal", "Sonipat", "Panchkula"],
            "Himachal Pradesh": ["Shimla", "Mandi", "Solan", "Dharamshala", "Bilaspur", "Kullu", "Chamba", "Hamirpur", "Una", "Nahan"],
            "Jharkhand": ["Ranchi", "Jamshedpur", "Dhanbad", "Bokaro", "Hazaribagh", "Deoghar", "Giridih", "Phusro", "Adityapur", "Chatra"],
            "Karnataka": ["Bangalore", "Mysore", "Hubli", "Mangalore", "Belgaum", "Gulbarga", "Davangere", "Bellary", "Bijapur", "Raichur"],
            "Kerala": ["Kochi", "Thiruvananthapuram", "Kozhikode", "Thrissur", "Malappuram", "Kannur", "Kollam", "Alappuzha", "Palakkad", "Kottayam"],
            "Madhya Pradesh": ["Indore", "Bhopal", "Gwalior", "Jabalpur", "Ujjain", "Sagar", "Ratlam", "Satna", "Dewas", "Burhanpur"],
            "Maharashtra": ["Mumbai", "Pune", "Nagpur", "Thane", "Nashik", "Aurangabad", "Solapur", "Amravati", "Kolhapur", "Sangli"],
            "Manipur": ["Imphal", "Thoubal", "Kakching", "Churachandpur", "Bishnupur", "Ukhrul", "Senapati"],
            "Meghalaya": ["Shillong", "Tura", "Jowai", "Nongstoin", "Baghmara", "Williamnagar"],
            "Mizoram": ["Aizawl", "Lunglei", "Champhai", "Saiha", "Kolasib", "Serchhip"],
            "Nagaland": ["Dimapur", "Kohima", "Mokokchung", "Tuensang", "Wokha", "Zunheboto"],
            "Odisha": ["Bhubaneswar", "Cuttack", "Rourkela", "Berhampur", "Sambalpur", "Puri", "Baleshwar", "Bhadrak", "Baripada", "Jharsuguda"],
            "Punjab": ["Ludhiana", "Amritsar", "Jalandhar", "Patiala", "Bathinda", "Pathankot", "Hoshiarpur", "Batala", "Moga", "Abohar"],
            "Rajasthan": ["Jaipur", "Jodhpur", "Kota", "Bikaner", "Ajmer", "Udaipur", "Bhilwara", "Alwar", "Bharatpur", "Sikar"],
            "Sikkim": ["Gangtok", "Namchi", "Mangan", "Gyalshing", "Singtam"],
            "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai", "Tiruchirappalli", "Salem", "Tirunelveli", "Erode", "Vellore", "Tuticorin", "Dindigul"],
            "Telangana": ["Hyderabad", "Warangal", "Nizamabad", "Karimnagar", "Khammam", "Ramagundam", "Mahbubnagar", "Nalgonda", "Adilabad", "Siddipet"],
            "Tripura": ["Agartala", "Udaipur", "Dharmanagar", "Kailasahar", "Belonia", "Ambassa"],
            "Uttar Pradesh": ["Lucknow", "Kanpur", "Agra", "Varanasi", "Meerut", "Allahabad", "Bareilly", "Ghaziabad", "Aligarh", "Moradabad"],
            "Uttarakhand": ["Dehradun", "Haridwar", "Roorkee", "Haldwani", "Rudrapur", "Kashipur", "Rishikesh", "Nainital", "Mussoorie"],
            "West Bengal": ["Kolkata", "Howrah", "Durgapur", "Asansol", "Siliguri", "Bardhaman", "Malda", "Bahraich", "Jalpaiguri", "Kharagpur"],
            "Andaman and Nicobar Islands": ["Port Blair", "Garacharma", "Bambooflat"],
            "Chandigarh": ["Chandigarh"],
            "Dadra and Nagar Haveli and Daman and Diu": ["Daman", "Silvassa", "Diu"],
            "Delhi": ["New Delhi", "Delhi"],
            "Jammu and Kashmir": ["Srinagar", "Jammu", "Anantnag", "Baramulla", "Kathua", "Udhampur", "Sopore", "Poonch"],
            "Ladakh": ["Leh", "Kargil"],
            "Lakshadweep": ["Kavaratti", "Agatti"],
            "Puducherry": ["Puducherry", "Karaikal", "Mahe", "Yanam"]
        };

        // Function to populate state dropdown
        function populateStates() {
            const stateSelect = document.getElementById('pharma_state');
            const states = Object.keys(indianStatesAndCities).sort();
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        }

        // Function to populate cities based on selected state
        function populateCities(selectedState) {
            const citySelect = document.getElementById('pharma_city');
            citySelect.innerHTML = '<option value="">Select City</option>';
            
            if (selectedState && indianStatesAndCities[selectedState]) {
                indianStatesAndCities[selectedState].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        // 1. Helper Function: Add a blank medicine row
        function addMedicineRow(name = '', freq = '', nextDose = '', index = null) {
            const container = document.getElementById('meds-container');
            const rowId = Date.now(); // Unique ID for finding this row later
            
            const html = `
                <div class="med-card" id="row-${rowId}">
                    <button type="button" class="remove-btn" onclick="removeRow('${rowId}')">×</button>
                    <label>Medicine Name</label>
                    <input type="text" class="med-name" value="${name}" placeholder="e.g. Paracetamol">
                    <label style="margin-top:10px">Frequency (Hours)</label>
                    <input type="number" class="med-freq" value="${freq}" placeholder="e.g. 8">
                    <label style="margin-top:10px">Next Dose</label>
                    <input type="datetime-local" class="med-next-dose" value="${nextDose}">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            
            // Attach error clearing listeners to the newly added row
            const newRow = document.getElementById(`row-${rowId}`);
            newRow.querySelectorAll('.med-name, .med-freq, .med-next-dose').forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentElement.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                });
            });
        }

        // 2. Helper Function: Remove a row
        function removeRow(id) {
            document.getElementById(`row-${id}`).remove();
        }

        // 3. Main Load Function
        async function loadData() {
            // Show form immediately if no ID (Manual Entry Mode)
            if (!recordId) {
                console.log("No ID found, loading empty form.");
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataForm').style.display = 'block';
                addMedicineRow(); // Add one empty row to start
                return;
            }

            let responseData = null;
            let preferredLang = null;
            let pharmaState = null;
            let pharmaCity = null;
            
            try {
                const response = await fetch(GET_WEBHOOK, {
                    method: 'GET',
                    headers: {
                        'X-User-Num': recordId
                    }
                });
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                responseData = await response.json();
                
                // Handle array response - extract first element if it's an array
                const data = Array.isArray(responseData) ? responseData[0] : responseData;
                
                // Store preferred language for later use
                preferredLang = data.patient?.PreferredLanguage || data.patient?.preferred_language;

                // Safe Navigation: Check if fields exist, otherwise default to empty string
                document.getElementById('p_name').value = data.patient?.name || '';
                document.getElementById('p_age').value = data.patient?.age || '';
                document.getElementById('p_diagnosis').value = data.patient?.diagnosis || '';
                document.getElementById('p_mobile').value = data.patient?.number || '';
                
                // Populate Doctor fields
                document.getElementById('d_name').value = data.doctor?.doctor_name || '';
                document.getElementById('d_clinic').value = data.doctor?.clinic_name || '';
                document.getElementById('d_contact').value = data.doctor?.doctor_number || '';

                // Populate Pharma fields - map from pharmaRep* fields to expected fields
                if (data.pharma) {
                    document.getElementById('pharma_name').value = data.pharma?.pharmaRepName || data.pharma?.name || '';
                    document.getElementById('pharma_contact').value = data.pharma?.contact || data.pharma?.contact_number || '';
                    document.getElementById('pharma_company').value = data.pharma?.pharmaRepCompany || data.pharma?.company || '';
                    document.getElementById('pharma_area').value = data.pharma?.pharmaRepArea || data.pharma?.area || '';
                    
                    // Store state and city values for later use (after form is visible)
                    pharmaState = data.pharma?.pharmaRepState || data.pharma?.state;
                    pharmaCity = data.pharma?.pharmaRepCity || data.pharma?.city;
                }

                // Populate Medicines if they exist
                if (data.medicines && data.medicines.length > 0) {
                    data.medicines.forEach((med, index) => {
                        // Convert reminder_time or last_taken to datetime-local format if it exists
                        let nextDoseValue = '';
                        // Try reminder_time first, then last_taken, then next_dose
                        const dateString = med.reminder_time || med.last_taken || med.next_dose;
                        if (dateString) {
                            const date = new Date(dateString);
                            if (!isNaN(date.getTime())) {
                                // Format as YYYY-MM-DDTHH:mm for datetime-local input
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const hours = String(date.getHours()).padStart(2, '0');
                                const minutes = String(date.getMinutes()).padStart(2, '0');
                                nextDoseValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                            }
                        }
                        addMedicineRow(med.medicine_name, med.frequency_hours, nextDoseValue, index);
                    });
                } else {
                    // If medicines list is empty, show one blank row
                    addMedicineRow();
                }

            } catch (err) {
                console.warn("Could not load data (or data empty). Showing blank form.", err);
                // Even on error, we show the form so the user isn't stuck
                addMedicineRow(); 
            } finally {
                // Always hide loader and show form
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataForm').style.display = 'block';
                
                // Set language value after form is visible to ensure it's properly selected
                if (preferredLang) {
                    const langSelect = document.getElementById('p_language');
                    const langValue = preferredLang.trim();
                    // Check if the value exists in the select options
                    const optionExists = Array.from(langSelect.options).some(opt => opt.value === langValue);
                    if (optionExists) {
                        langSelect.value = langValue;
                        // Trigger change event to ensure the selection is registered
                        langSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    } else {
                        console.warn('Language value not found in options:', langValue);
                    }
                }
                
                // Set state and city values after form is visible to ensure they're properly selected
                if (pharmaState) {
                    const stateSelect = document.getElementById('pharma_state');
                    const stateValue = pharmaState.trim();
                    // Check if the value exists in the select options
                    const stateOptionExists = Array.from(stateSelect.options).some(opt => opt.value === stateValue);
                    if (stateOptionExists) {
                        stateSelect.value = stateValue;
                        // Populate cities for the selected state
                        populateCities(stateValue);
                        
                        // Set city value after cities are populated (use setTimeout to ensure cities are loaded)
                        if (pharmaCity) {
                            setTimeout(() => {
                                const citySelect = document.getElementById('pharma_city');
                                const cityValue = pharmaCity.trim();
                                // Check if the value exists in the select options
                                const cityOptionExists = Array.from(citySelect.options).some(opt => opt.value === cityValue);
                                if (cityOptionExists) {
                                    citySelect.value = cityValue;
                                    // Trigger change event to ensure the selection is registered
                                    citySelect.dispatchEvent(new Event('change', { bubbles: true }));
                                } else {
                                    console.warn('City value not found in options:', cityValue);
                                }
                            }, 50); // Small delay to ensure cities are populated
                        }
                        
                        // Trigger change event to ensure the selection is registered
                        stateSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    } else {
                        console.warn('State value not found in options:', stateValue);
                    }
                }
            }
        }

        // 4. Validation Function
        function validateForm() {
            let isValid = true;
            const errors = [];

            // Remove previous error styling
            document.querySelectorAll('.error-field').forEach(el => {
                el.classList.remove('error-field');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.remove();
            });

            // Patient Info Validation
            const pName = document.getElementById('p_name').value.trim();
            const pAge = document.getElementById('p_age').value.trim();
            const pDiagnosis = document.getElementById('p_diagnosis').value.trim();
            const pMobile = document.getElementById('p_mobile').value.trim();
            const pLanguage = document.getElementById('p_language').value.trim();

            if (!pName) {
                markError('p_name', 'Patient name is required');
                isValid = false;
            }
            if (!pAge) {
                markError('p_age', 'Patient age is required');
                isValid = false;
            }
            if (!pDiagnosis) {
                markError('p_diagnosis', 'Diagnosis is required');
                isValid = false;
            }
            if (!pMobile) {
                markError('p_mobile', 'Mobile number is required');
                isValid = false;
            }
            if (!pLanguage) {
                markError('p_language', 'Preferred language is required');
                isValid = false;
            }

            // Doctor Info Validation
            const dName = document.getElementById('d_name').value.trim();
            const dClinic = document.getElementById('d_clinic').value.trim();
            const dContact = document.getElementById('d_contact').value.trim();

            if (!dName) {
                markError('d_name', 'Doctor name is required');
                isValid = false;
            }
            if (!dClinic) {
                markError('d_clinic', 'Clinic name is required');
                isValid = false;
            }
            if (!dContact) {
                markError('d_contact', 'Doctor contact number is required');
                isValid = false;
            }

            // Pharma Details Validation
            const pharmaName = document.getElementById('pharma_name').value.trim();
            const pharmaContact = document.getElementById('pharma_contact').value.trim();
            const pharmaCompany = document.getElementById('pharma_company').value.trim();
            const pharmaArea = document.getElementById('pharma_area').value.trim();
            const pharmaState = document.getElementById('pharma_state').value.trim();
            const pharmaCity = document.getElementById('pharma_city').value.trim();

            if (!pharmaName) {
                markError('pharma_name', 'Medical Representative name is required');
                isValid = false;
            }
            if (!pharmaContact) {
                markError('pharma_contact', 'Pharma contact number is required');
                isValid = false;
            }
            if (!pharmaCompany) {
                markError('pharma_company', 'Company name is required');
                isValid = false;
            }
            if (!pharmaArea) {
                markError('pharma_area', 'Area is required');
                isValid = false;
            }
            if (!pharmaState) {
                markError('pharma_state', 'State is required');
                isValid = false;
            }
            if (!pharmaCity) {
                markError('pharma_city', 'City is required');
                isValid = false;
            }

            // Medicines Validation - At least one medicine with all fields
            const medCards = document.querySelectorAll('.med-card');
            let hasValidMedicine = false;
            let hasAnyMedicineData = false;

            if (medCards.length === 0) {
                alert('❌ Please add at least one medicine.');
                isValid = false;
            } else {
                medCards.forEach((card, index) => {
                    const nameInput = card.querySelector('.med-name');
                    const freqInput = card.querySelector('.med-freq');
                    const nextDoseInput = card.querySelector('.med-next-dose');
                    
                    const name = nameInput ? nameInput.value.trim() : '';
                    const freq = freqInput ? freqInput.value.trim() : '';
                    const nextDose = nextDoseInput ? nextDoseInput.value.trim() : '';

                    if (name || freq || nextDose) {
                        hasAnyMedicineData = true;
                        // If any field is filled, all must be filled
                        if (!name) {
                            markError(nameInput, 'Medicine name is required');
                            isValid = false;
                        }
                        if (!freq) {
                            markError(freqInput, 'Frequency is required');
                            isValid = false;
                        }
                        if (!nextDose) {
                            markError(nextDoseInput, 'Next dose is required');
                            isValid = false;
                        }
                        if (name && freq && nextDose) {
                            hasValidMedicine = true;
                        }
                    }
                });

                if (hasAnyMedicineData && !hasValidMedicine) {
                    alert('❌ Please fill in all fields for at least one medicine (name, frequency, and next dose).');
                    isValid = false;
                } else if (!hasAnyMedicineData) {
                    alert('❌ Please add at least one medicine with all fields filled.');
                    isValid = false;
                }
            }

            // Consent Checkbox Validation
            const consentCheckbox = document.getElementById('consent_checkbox');
            const consentContainer = consentCheckbox.closest('.consent-checkbox');
            if (!consentCheckbox.checked) {
                consentCheckbox.classList.add('error-field');
                const errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'You must provide consent to proceed';
                if (consentContainer) {
                    consentContainer.appendChild(errorMsg);
                }
                isValid = false;
            }

            return isValid;
        }

        // Helper function to mark fields with errors
        function markError(elementIdOrElement, message) {
            const element = typeof elementIdOrElement === 'string' 
                ? document.getElementById(elementIdOrElement) 
                : elementIdOrElement;
            
            if (element) {
                element.classList.add('error-field');
                const errorMsg = document.createElement('span');
                errorMsg.className = 'error-message';
                errorMsg.textContent = message;
                
                // Insert error message after the input/select element
                if (element.parentElement) {
                    element.parentElement.appendChild(errorMsg);
                }
            }
        }

        // 5. Save Logic
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate form before proceeding
            if (!validateForm()) {
                // Scroll to first error
                const firstError = document.querySelector('.error-field');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }
            
            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.textContent = "Saving...";
            submitBtn.disabled = true;

            const updatedData = {
                id: recordId || 'NEW_ENTRY', // Handle case where ID is missing
                patient: {
                    name: document.getElementById('p_name').value,
                    age: document.getElementById('p_age').value,
                    diagnosis: document.getElementById('p_diagnosis').value,
                    mobile_number: document.getElementById('p_mobile').value,
                    preferred_language: document.getElementById('p_language').value
                },
                doctor: {
                    name: document.getElementById('d_name').value,
                    clinic_name: document.getElementById('d_clinic').value,
                    contact_number: document.getElementById('d_contact').value
                },
                pharma: {
                    name: document.getElementById('pharma_name').value,
                    contact_number: document.getElementById('pharma_contact').value,
                    company: document.getElementById('pharma_company').value,
                    area: document.getElementById('pharma_area').value,
                    city: document.getElementById('pharma_city').value,
                    state: document.getElementById('pharma_state').value
                },
                medicines: []
            };

            document.querySelectorAll('.med-card').forEach(card => {
                const name = card.querySelector('.med-name').value;
                const freq = card.querySelector('.med-freq').value;
                const nextDoseInput = card.querySelector('.med-next-dose').value;
                
                // Only add if name is not empty
                if(name.trim() !== "") {
                    const medicineData = {
                        medicine_name: name,
                        frequency_hours: freq
                    };
                    
                    // Convert datetime-local to ISO format if provided
                    if (nextDoseInput) {
                        const date = new Date(nextDoseInput);
                        if (!isNaN(date.getTime())) {
                            medicineData.next_dose = date.toISOString();
                        }
                    }
                    
                    updatedData.medicines.push(medicineData);
                }
            });

            try {
                const response = await fetch(POST_WEBHOOK, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Num': recordId || ''
                    },
                    body: JSON.stringify(updatedData)
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                alert("✅ Saved successfully! You can close this page.");
                window.close();
            } catch (error) {
                alert("❌ Error saving data. Please try again.");
                console.error("Save error:", error);
                submitBtn.textContent = "✅ Confirm & Save";
                submitBtn.disabled = false;
            }
        });

        // Function to clear error styling when user starts typing/selecting
        function clearErrorOnInput(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // For input fields
                element.addEventListener('input', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentElement.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                });
                // For select fields
                element.addEventListener('change', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentElement.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                });
            }
        }

        // Function to clear error for medicine fields
        function clearMedicineErrors() {
            document.querySelectorAll('.med-name, .med-freq, .med-next-dose').forEach(input => {
                input.addEventListener('input', function() {
                    this.classList.remove('error-field');
                    const errorMsg = this.parentElement.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                });
            });
        }

        // Clear error on consent checkbox change
        function setupConsentCheckboxListener() {
            const consentCheckbox = document.getElementById('consent_checkbox');
            if (consentCheckbox) {
                consentCheckbox.addEventListener('change', function() {
                    this.classList.remove('error-field');
                    const consentContainer = this.closest('.consent-checkbox');
                    if (consentContainer) {
                        const errorMsg = consentContainer.querySelector('.error-message');
                        if (errorMsg) {
                            errorMsg.remove();
                        }
                    }
                });
            }
        }
        
        // Setup consent checkbox listener when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupConsentCheckboxListener);
        } else {
            setupConsentCheckboxListener();
        }

        // Initialize states dropdown and add event listener for state change
        populateStates();
        document.getElementById('pharma_state').addEventListener('change', function() {
            populateCities(this.value);
        });

        // Clear errors on input for all form fields
        clearErrorOnInput('p_name');
        clearErrorOnInput('p_age');
        clearErrorOnInput('p_diagnosis');
        clearErrorOnInput('p_mobile');
        clearErrorOnInput('p_language');
        clearErrorOnInput('d_name');
        clearErrorOnInput('d_clinic');
        clearErrorOnInput('d_contact');
        clearErrorOnInput('pharma_name');
        clearErrorOnInput('pharma_contact');
        clearErrorOnInput('pharma_company');
        clearErrorOnInput('pharma_area');
        clearErrorOnInput('pharma_state');
        clearErrorOnInput('pharma_city');

        // Start
        loadData();
        
        // Clear medicine errors after form loads (will be called after medicines are added)
        setTimeout(clearMedicineErrors, 500);

    </script>
</body>
</html>